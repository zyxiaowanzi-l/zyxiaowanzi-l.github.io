# 🚀 腾讯云云函数详细部署指南

## 📋 目录
- [部署前准备](#部署前准备)
- [安装腾讯云CLI工具](#安装腾讯云cli工具)
- [登录腾讯云账户](#登录腾讯云账户)
- [部署云函数](#部署云函数)
- [验证部署结果](#验证部署结果)
- [常见问题解决](#常见问题解决)
- [测试云函数](#测试云函数)
- [前端集成](#前端集成)

---

## 🎯 部署前准备

### ✅ 检查清单
- [ ] 已开通腾讯云账户
- [ ] 已开通云开发服务
- [ ] 已创建云开发环境
- [ ] 已获取环境ID：`cloud1-9ghdf1i93f8fb2b9`
- [ ] 已开通云函数服务
- [ ] 已开通数据库服务
- [ ] 已开通云存储服务

### 🔑 重要信息
- **环境ID**: `cloud1-9ghdf1i93f8fb2b9`
- **项目名称**: 恋爱回忆录
- **云函数数量**: 4个
- **数据库集合**: 4个

---

## 🛠️ 安装腾讯云CLI工具

### 方法1：使用npm安装（推荐）
```bash
# 打开PowerShell，执行以下命令
npm install -g @cloudbase/cli
```

### 方法2：如果npm安装失败
```bash
# 使用cnpm（国内镜像）
npm install -g cnpm --registry=https://registry.npmmirror.com
cnpm install -g @cloudbase/cli

# 或者使用yarn
npm install -g yarn
yarn global add @cloudbase/cli
```

### 验证安装
```bash
# 检查版本
tcb --version

# 或者
cloudbase --version
```

### ⚠️ 安装失败解决方案
1. **权限问题**: 以管理员身份运行PowerShell
2. **网络问题**: 使用国内镜像源
3. **Node.js版本**: 确保Node.js版本 >= 14

---

## 🔐 登录腾讯云账户

### 第一步：执行登录命令
```bash
tcb login
```

### 第二步：浏览器授权
1. 系统会自动打开浏览器
2. 使用腾讯云账户登录
3. 授权CLI工具访问您的云资源
4. 授权成功后，浏览器会显示"授权成功"

### 第三步：验证登录状态
```bash
# 检查登录状态
tcb login --check

# 查看当前用户信息
tcb user info
```

### 🔍 登录失败解决方案
1. **浏览器未打开**: 手动访问 https://console.cloud.tencent.com/tcb
2. **授权失败**: 清除浏览器缓存，重新登录
3. **网络问题**: 检查网络连接，使用VPN

---

## 🚀 部署云函数

### 第一步：进入项目目录
```bash
# 切换到项目目录
cd "D:\桌面\cursor web\cloud-functions"
```

### 第二步：检查云函数目录结构
```
cloud-functions/
├── addMemory/          # 添加回忆云函数
├── getLuckyNote/       # 获取幸运签云函数
├── getLoveQuiz/        # 获取爱情问答云函数
├── getMemories/        # 获取回忆列表云函数
├── deploy-cloud.ps1    # 部署脚本
├── deploy.ps1          # 简化部署脚本
├── deploy.bat          # Windows批处理脚本
└── package.json        # 项目配置
```

### 第三步：执行部署

#### 方式1：使用完整部署脚本（推荐）
```bash
# 在PowerShell中运行
.\deploy-cloud.ps1
```

#### 方式2：使用简化部署脚本
```bash
# 在PowerShell中运行
.\deploy.ps1
```

#### 方式3：手动部署每个云函数
```bash
# 部署 getLuckyNote
tcb fn deploy getLuckyNote --env cloud1-9ghdf1i93f8fb2b9

# 部署 getLoveQuiz
tcb fn deploy getLoveQuiz --env cloud1-9ghdf1i93f8fb2b9

# 部署 addMemory
tcb fn deploy addMemory --env cloud1-9ghdf1i93f8fb2b9

# 部署 getMemories
tcb fn deploy getMemories --env cloud1-9ghdf1i93f8fb2b9
```

### 第四步：监控部署进度
部署过程中会显示：
- ✅ 云函数部署成功
- ❌ 云函数部署失败
- 📊 部署进度信息

---

## ✅ 验证部署结果

### 第一步：在腾讯云控制台验证
1. 访问：https://console.cloud.tencent.com/tcb
2. 选择环境：`cloud1-9ghdf1i93f8fb2b9`
3. 点击左侧菜单"云函数"
4. 确认以下4个云函数都已部署：
   - `getLuckyNote`
   - `getLoveQuiz`
   - `addMemory`
   - `getMemories`

### 第二步：检查云函数状态
每个云函数应该显示：
- 状态：运行中
- 版本：最新版本
- 运行环境：Node.js 16.13
- 内存：128MB
- 超时时间：20秒

### 第三步：查看部署日志
1. 点击云函数名称
2. 查看"版本管理"标签
3. 检查"部署日志"是否有错误

---

## 🧪 测试云函数

### 在控制台测试

#### 1. 测试 getLuckyNote
- **函数名**: getLuckyNote
- **测试参数**: `{}`
- **预期结果**: 返回一个随机的幸运签内容

#### 2. 测试 getLoveQuiz
- **函数名**: getLoveQuiz
- **测试参数**: `{}`
- **预期结果**: 返回一个随机的爱情问答

#### 3. 测试 addMemory
- **函数名**: addMemory
- **测试参数**: 
```json
{
  "title": "测试回忆",
  "content": "这是一个测试回忆内容",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```
- **预期结果**: 返回添加成功的确认信息

#### 4. 测试 getMemories
- **函数名**: getMemories
- **测试参数**: `{}`
- **预期结果**: 返回回忆列表数组

### 测试结果验证
- ✅ 云函数执行成功
- ✅ 返回数据格式正确
- ✅ 无错误日志
- ✅ 响应时间合理（< 5秒）

---

## 🔧 常见问题解决

### 问题1：CLI工具未安装
**错误信息**: `tcb : 无法将"tcb"项识别为 cmdlet`
**解决方案**:
```bash
# 重新安装
npm install -g @cloudbase/cli

# 检查PATH环境变量
echo $env:PATH

# 如果PATH中没有npm全局路径，手动添加
$env:PATH += ";C:\Users\$env:USERNAME\AppData\Roaming\npm"
```

### 问题2：未登录腾讯云
**错误信息**: `未登录腾讯云，请先登录`
**解决方案**:
```bash
# 重新登录
tcb login

# 检查登录状态
tcb login --check
```

### 问题3：环境ID错误
**错误信息**: `环境不存在或无权访问`
**解决方案**:
1. 检查 `cloudbase-config.js` 中的环境ID
2. 确认环境ID是否正确
3. 检查是否有访问权限

### 问题4：云函数部署失败
**错误信息**: `云函数部署失败`
**解决方案**:
1. 检查云函数服务是否已开通
2. 确认代码语法是否正确
3. 查看错误日志获取详细信息
4. 检查云函数目录结构是否正确

### 问题5：依赖包安装失败
**错误信息**: `npm install 失败`
**解决方案**:
```bash
# 使用国内镜像
npm config set registry https://registry.npmmirror.com

# 或者使用cnpm
npm install -g cnpm
cnpm install
```

### 问题6：权限不足
**错误信息**: `权限不足`
**解决方案**:
1. 以管理员身份运行PowerShell
2. 检查腾讯云账户权限
3. 确认环境访问权限

---

## 🌐 前端集成

### 更新前端配置
部署完成后，确保前端代码中的环境ID正确：

```javascript
// 在 cloudbase-core.js 中
const ENV_ID = 'cloud1-9ghdf1i93f8fb2b9';
```

### 测试前端功能
1. 打开网站
2. 测试幸运签功能
3. 测试爱情问答功能
4. 测试添加回忆功能
5. 测试查看回忆功能

---

## 📱 部署后维护

### 日常监控
1. 定期检查云函数运行状态
2. 监控云函数调用次数和响应时间
3. 查看错误日志和异常情况

### 更新部署
当代码有更新时：
```bash
# 重新部署所有云函数
.\deploy-cloud.ps1

# 或者部署特定云函数
tcb fn deploy 云函数名 --env cloud1-9ghdf1i93f8fb2b9
```

### 备份和恢复
1. 定期备份云函数代码
2. 保存环境配置信息
3. 记录部署步骤和配置

---

## 🎉 部署成功标志

当您看到以下信息时，说明部署完全成功：

```
✅ getLuckyNote 部署成功！
✅ getLoveQuiz 部署成功！
✅ addMemory 部署成功！
✅ getMemories 部署成功！
🎉 云函数部署完成！
```

## 📞 技术支持

如果遇到无法解决的问题：
1. 查看腾讯云官方文档
2. 检查云函数运行日志
3. 联系腾讯云技术支持
4. 在开发者社区寻求帮助

---

**祝您部署顺利！如果遇到任何问题，请按照本指南逐步排查。**
